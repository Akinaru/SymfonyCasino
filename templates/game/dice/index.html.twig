{% extends 'game/base_game.html.twig' %}

{% block game_title %}ðŸŽ° Symfsino - Dice{% endblock %}

{% block game_styles %}
    <link rel="stylesheet" href="{{ asset('styles/game/dice.css') }}">
{% endblock %}

{% block game_sidebar %}
    <div class="card info-card text-light h-100">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <span class="typo-title mb-0">Pile ou Face</span>
            <small class="typo-helper">Min {{ minBet|default(1) }} Â· Max {{ maxBet|default(1000000) }}</small>
        </div>
        <div class="card-body form-compact">
            <div class="mb-3">
                <div class="typo-eyebrow">Balance</div>
                <div id="balanceDisplay" class="typo-kpi balance justify-content-start">
                    {{ component('Balance', { attributes: { id: 'header-balance-live' } }) }}
                </div>
            </div>

            <div class="mb-3">
                <div class="typo-eyebrow">Description</div>
                <p class="mb-0 typo-helper">{{ descriptionInGame }}</p>
            </div>

            <div class="mb-3">
                <label for="betInput" class="form-label">Montant du pari</label>
                <input id="betInput" type="number" class="form-control"
                       min="{{ minBet|default(1) }}" max="{{ maxBet|default(1000000) }}"
                       value="{{ minBet|default(1) }}">
                <div class="form-text text-secondary">Jouez de maniÃ¨re responsable.</div>
            </div>

            <div class="d-grid gap-2 mb-3">
                <button id="playBtn" class="btn btn-primary">Jouer</button>
            </div>

            <hr class="border-secondary">

            <div class="mb-2">
                <div class="typo-eyebrow">Auto-roll</div>
            </div>
            <div class="row g-2 align-items-end mb-2">
                <div class="col-6">
                    <label for="autoCount" class="form-label mb-1">Nombre de lancers</label>
                    <input id="autoCount" type="number" class="form-control" min="1" value="10">
                </div>
                <div class="col-6 d-grid">
                    <button id="autoStartBtn" class="btn btn-primary">Demarrer</button>
                </div>
            </div>
            <div class="d-grid">
                <button id="autoStopBtn" class="btn btn-primary" disabled>Stop</button>
            </div>
            <div class="mt-2">
                <small id="autoStatus" class="text-white-50">Auto : inactif</small>
            </div>
        </div>
    </div>
{% endblock %}

{% block game_playfield %}
    <div class="card game-card text-light h-100">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <span class="typo-title mb-0">Zone de jeu</span>
        </div>

        <div class="card-body">
            <div class="playfield-area">
                <div class="d-flex flex-column align-items-center gap-3">
                    <div class="status-row">
                        <div id="result" class="typo-kpi">En attenteâ€¦</div>
                    </div>

                    <div id="coin" class="coin">
                        <img id="coinImg" src="{{ asset('img/dice/wait.png') }}" alt="Attente">
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block more_content %}
    {# ðŸ”¹ Historique de session global (tous jeux confondus) #}
    {% include 'components/historique.html.twig' %}

    <div class="info-card card text-light mb-3">
        <div class="card-header border-secondary">
            <span class="typo-title">DerniÃ¨res parties Dice</span>
        </div>
        <div class="card-body">
            <div id="dice-last-games-panel"
                 data-face="{{ asset('img/dice/face.png') }}"
                 data-pile="{{ asset('img/dice/pile.png') }}">
                <table class="table table-dark table-sm mb-0 align-middle">
                    <thead>
                    <tr>
                        <th style="width:48px;">Avatar</th>
                        <th>Joueur</th>
                        <th style="min-width:100px;">Issue</th>
                        <th style="min-width:100px;">Date / heure</th>
                        <th class="text-start" style="width:120px;">Mise</th>
                        <th class="text-start" style="width:80px;">RÃ©sultat</th>
                    </tr>
                    </thead>
                    <tbody id="dice-last-games-list">
                    {% for game in lastGames %}
                        <tr>
                            <td>
                                <img src="{{ game.avatar_url }}"
                                     alt="Avatar"
                                     class="rounded"
                                     style="width:40px;height:40px;image-rendering:pixelated;">
                            </td>
                            <td class="small">
                                {{ game.username }}
                            </td>
                            <td>
                                <div style="height:70px;display:flex;align-items:center;">
                                    {% if game.isWin %}
                                        <img src="{{ asset('img/dice/face.png') }}"
                                             alt="Face"
                                             style="width:48px;height:48px;image-rendering:pixelated;">
                                    {% else %}
                                        <img src="{{ asset('img/dice/pile.png') }}"
                                             alt="Pile"
                                             style="width:48px;height:48px;image-rendering:pixelated;">
                                    {% endif %}
                                </div>
                            </td>
                            <td class="small">
                                {% if game.debut_le is defined and game.debut_le %}
                                    {{ game.debut_le|date('d/m/Y H:i') }}
                                {% endif %}
                            </td>
                            <td class="small text-start">
                                <span class="balance">{{ game.mise }}</span>
                            </td>
                            <td class="small text-end">
                                {% set net = game.resultat_net %}
                                {% if net > 0 %}
                                    <span class="text-success balance justify-content-end">+{{ net }}</span>
                                {% else %}
                                    <span class="balance justify-content-end">0</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="info-card card text-light mb-3">
        <div class="card-header border-secondary">
            <span class="typo-title">Ã€ propos du jeu</span>
        </div>
        <div class="card-body">
            <p class="mb-2 typo-helper">
                Pile ou Face est un jeu Ã  <strong>rÃ©sultat binaire</strong> : gain ou perte selon lâ€™issue. Lâ€™interface force lâ€™affichage
                <em>Face</em> en cas de gain et <em>Pile</em> en cas de perte pour une lecture immÃ©diate.
            </p>
            <ul class="mb-0">
                <li>
                    <img src="{{ asset('img/dice/face.png') }}" alt="Face" width="18" height="18" class="me-2 align-text-bottom">
                    Issue <strong>Face</strong> : paiement standard (ex. x2).
                </li>
                <li class="mt-1">
                    <img src="{{ asset('img/dice/pile.png') }}" alt="Pile" width="18" height="18" class="me-2 align-text-bottom">
                    Issue <strong>Pile</strong> : pari perdu.
                </li>
            </ul>
        </div>
    </div>

    <div class="info-card card text-light mb-3">
        <div class="card-header border-secondary">
            <span class="typo-title">Table des gains (exemple)</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-striped align-middle payout-table mb-0">
                    <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Paiement</th>
                        <th>Notes</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <img src="{{ asset('img/dice/face.png') }}" alt="Face" width="18" height="18" class="me-2 align-text-bottom">
                            Face (gain)
                        </td>
                        <td>x2 la mise</td>
                        <td>PlafonnÃ© par la limite de table</td>
                    </tr>
                    <tr>
                        <td>
                            <img src="{{ asset('img/dice/pile.png') }}" alt="Pile" width="18" height="18" class="me-2 align-text-bottom">
                            Pile (perte)
                        </td>
                        <td>0</td>
                        <td>La mise est perdue</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% endblock %}

{% block game_scripts %}
    <script type="module">
        (function () {
            let wired = false;
            let autoState = { active: false, total: 0, remaining: 0, stopFlag: false };

            function initCoinFlip() {
                if (wired) return;

                const playBtn    = document.getElementById('playBtn');
                const betInput   = document.getElementById('betInput');
                const coinEl     = document.getElementById('coin');
                const coinImg    = document.getElementById('coinImg');
                const resultEl   = document.getElementById('result');
                const balanceEl  = document.getElementById('balanceDisplay');

                const autoCount  = document.getElementById('autoCount');
                const autoStart  = document.getElementById('autoStartBtn');
                const autoStop   = document.getElementById('autoStopBtn');
                const autoStatus = document.getElementById('autoStatus');

                if (!playBtn || !betInput || !coinEl || !coinImg || !resultEl || !balanceEl || !autoCount || !autoStart || !autoStop || !autoStatus) return;
                wired = true;

                const endpoint = "{{ path('app_game_dice_play') }}";
                const csrf     = "{{ csrf_token('dice_play') }}";

                const waitSrc  = "{{ asset('img/dice/wait.png') }}";
                const pileSrc  = "{{ asset('img/dice/pile.png') }}";
                const faceSrc  = "{{ asset('img/dice/face.png') }}";

                coinImg.src = waitSrc;
                coinImg.alt = 'Attente';
                resultEl.textContent = resultEl.textContent?.trim() || 'En attenteâ€¦';

                const sleep = (ms) => new Promise(r => setTimeout(r, ms));

                function setBtnDisabled(disabled) {
                    playBtn.disabled = !!disabled;
                    playBtn.classList.toggle('disabled', !!disabled);
                    playBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
                }

                function setAutoControls(active) {
                    autoState.active = active;
                    autoStop.disabled = !active;
                    autoStart.disabled = !!active;
                    betInput.disabled = !!active;
                    setBtnDisabled(active);
                }

                function setStatus(text) { autoStatus.textContent = text; }
                function setResult(text) { if (text && text.trim() !== '') resultEl.textContent = text; }
                function resetVisual() {
                    coinEl.classList.remove('spin');
                    coinImg.src = waitSrc;
                    coinImg.alt = 'Attente';
                }

                function refreshHeaderBalanceLive() {
                    const containers = document.querySelectorAll('[id="header-balance-live"]');
                    if (!containers.length) return;

                    containers.forEach((container) => {
                        const btn = container.querySelector('[data-live-action-param="refresh"]');
                        if (!btn) return;

                        btn.click();
                    });
                }

                async function apiPlay(amount) {
                    const res  = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ amount, _token: csrf })
                    });
                    const data = await res.json().catch(() => null);
                    if (!res.ok || !data || data.ok === false) {
                        const msg = (data && typeof data.error === 'string' && data.error.trim() !== '') ? data.error : `Erreur (${res.status})`;
                        throw new Error(msg);
                    }
                    return data;
                }

                function animateSpin() {
                    coinEl.classList.remove('spin');
                    void coinEl.offsetWidth;
                    coinEl.classList.add('spin');
                }

                async function applyResultFromData(data, amount) {
                    const payout = Number(data.payout || 0);
                    const isWin  = (typeof data.win === 'boolean') ? data.win : (payout > 0);

                    await sleep(450);
                    const side = isWin ? 'face' : 'pile';
                    coinImg.src = side === 'face' ? faceSrc : pileSrc;
                    coinImg.alt = side === 'face' ? 'Face' : 'Pile';

                    if (isWin) {
                        setResult(`Tu as gagnÃ© ${payout}`);
                    } else {
                        setResult(`Tu as perdu ${amount}`);
                    }

                    refreshHeaderBalanceLive();

                    // ðŸ”¹ Mise Ã  jour des stats de session (tous jeux confondus)
                    if (window.SymfsinoSessionHistory && typeof window.SymfsinoSessionHistory.update === 'function') {
                        const deltaNet = payout - amount;
                        window.SymfsinoSessionHistory.update(deltaNet, amount, payout);
                    }
                }

                async function playOnce(amount) {
                    setResult('Lancementâ€¦');
                    animateSpin();
                    const data = await apiPlay(amount);
                    await applyResultFromData(data, amount);
                }

                async function handleManualPlay(ev) {
                    if (ev) ev.preventDefault();
                    if (autoState.active) return;
                    const amount = parseInt(betInput.value, 10) || 0;
                    setBtnDisabled(true);
                    try {
                        await playOnce(amount);
                    } catch (e) {
                        resetVisual();
                        setResult(e.message || 'Erreur inconnue');
                    } finally {
                        setBtnDisabled(false);
                    }
                }

                async function runAuto() {
                    const amount = parseInt(betInput.value, 10) || 0;
                    autoState.stopFlag = false;
                    setAutoControls(true);
                    while (autoState.remaining > 0 && !autoState.stopFlag) {
                        const idx = autoState.total - autoState.remaining + 1;
                        setStatus(`Auto : lancer ${idx} / ${autoState.total}`);
                        try {
                            await playOnce(amount);
                        } catch (e) {
                            resetVisual();
                            setResult(e.message || 'Erreur');
                            break;
                        }
                        autoState.remaining--;
                        if (autoState.remaining > 0 && !autoState.stopFlag) {
                            await sleep(500);
                        }
                    }
                    setStatus('Auto : terminÃ©');
                    setAutoControls(false);
                }

                function onAutoStart(ev) {
                    if (ev) ev.preventDefault();
                    if (autoState.active) return;
                    const n = Math.max(1, parseInt(autoCount.value, 10) || 0);
                    autoState.total = n;
                    autoState.remaining = n;
                    setStatus(`Auto : prÃªt (${n} lancers)`);
                    runAuto();
                }

                function onAutoStop(ev) {
                    if (ev) ev.preventDefault();
                    if (!autoState.active) return;
                    autoState.stopFlag = true;
                    setStatus('Auto : arrÃªt demandÃ©â€¦');
                }

                playBtn.addEventListener('click', handleManualPlay);
                autoStart.addEventListener('click', onAutoStart);
                autoStop.addEventListener('click', onAutoStop);
            }

            document.addEventListener('DOMContentLoaded', initCoinFlip);
            document.addEventListener('turbo:load', initCoinFlip);
        })();
    </script>
{% endblock %}
