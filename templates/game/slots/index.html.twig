{% extends 'game/base_game.html.twig' %}

{% block game_title %}ðŸŽ° Symfsino - Slots{% endblock %}

{% block game_styles %}
    <link rel="stylesheet" href="{{ asset('styles/game/slots.css') }}">
{% endblock %}

{% block game_sidebar %}
    <div class="card info-card text-light h-100">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <span class="typo-title mb-0">Slots 3Ã—3</span>
            <small class="typo-helper">Min {{ minBet|default(1) }} Â· Max {{ maxBet|default(1000000) }}</small>
        </div>

        <div class="card-body form-compact">
            <div class="mb-3">
                <div class="typo-eyebrow">Balance</div>
                <div id="balanceDisplay" class="typo-kpi balance justify-content-start">
                    {{ component('Balance', { attributes: { id: 'header-balance-live' } }) }}
                </div>
            </div>

            <div class="mb-3">
                <div class="typo-eyebrow">Description</div>
                <p class="mb-0 typo-helper">{{ descriptionInGame }}</p>
            </div>

            <div class="mb-3">
                <label for="betInput" class="form-label">Mise</label>
                <input id="betInput" type="number" class="form-control"
                       min="{{ minBet|default(1) }}" max="{{ maxBet|default(1000000) }}"
                       value="{{ minBet|default(1) }}">
                <div class="form-text text-secondary">Mise par lancer.</div>
            </div>

            <div class="d-grid gap-2 mb-3">
                <button id="playBtn" class="btn btn-primary">Lancer</button>
            </div>

            <hr class="border-secondary">

            <div class="mb-2"><div class="typo-eyebrow">Auto-roll</div></div>
            <div class="row g-2 align-items-end mb-2">
                <div class="col-6">
                    <label for="autoCount" class="form-label mb-1">Nombre de lancers</label>
                    <input id="autoCount" type="number" class="form-control" min="1" value="10">
                </div>
                <div class="col-6 d-grid">
                    <button id="autoStartBtn" class="btn btn-primary">Demarrer</button>
                </div>
            </div>
            <div class="d-grid">
                <button id="autoStopBtn" class="btn btn-primary" disabled>Stop</button>
            </div>
            <div class="mt-2"><small id="autoStatus" class="text-white-50">Auto : inactif</small></div>
        </div>
    </div>
{% endblock %}

{% block game_playfield %}
    <div class="card game-card text-light h-100">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <span class="typo-title mb-0">Zone de jeu</span>
            <small class="typo-helper">Lignes: 3H Â· 3V Â· 2D</small>
        </div>

        <div class="card-body slot-wrapper">
            <div class="reels-wrap">
                <div class="reels" id="reels">
                    <div class="reel"><div class="reel-strip" data-reel="0"></div></div>
                    <div class="reel"><div class="reel-strip" data-reel="1"></div></div>
                    <div class="reel"><div class="reel-strip" data-reel="2"></div></div>
                </div>
            </div>

            <div class="status-panel mt-3">
                <div id="result" class="typo-kpi text-center">En attenteâ€¦</div>
            </div>

            <div class="text-center">
                <div id="winLines" class="small text-white-50">â€”</div>
            </div>
        </div>
    </div>
{% endblock %}

{% block more_content %}
    {# ðŸ”¹ Historique de session global (tous jeux confondus) #}
    {% include 'components/historique.html.twig' %}

    <div class="info-card card text-light mb-3">
        <div id="last-games-panel"
             data-slot1="{{ asset('img/slots/slot1.png') }}"
             data-slot2="{{ asset('img/slots/slot2.png') }}"
             data-slot3="{{ asset('img/slots/slot3.png') }}"
             data-slot4="{{ asset('img/slots/slot4.png') }}"
             data-slot5="{{ asset('img/slots/slot5.png') }}"
             data-slot6="{{ asset('img/slots/slot6.png') }}"
             data-slot7="{{ asset('img/slots/slot7.png') }}"
             data-slot8="{{ asset('img/slots/slot8.png') }}"
        >
            <div class="card-header border-secondary">
                <span class="typo-title">DerniÃ¨res parties</span>
            </div>

            <div class="card-body">
                <table class="table table-dark table-sm mb-0 align-middle">
                    <thead>
                    <tr>
                        <th style="width:32px;">Avatar</th>
                        <th>Joueur</th>
                        <th style="min-width:80px;">Grille</th>
                        <th style="min-width:100px;">Date / heure</th>
                        <th class="text-start" style="width:120px;">Mise</th>
                        <th class="text-start" style="width:80px;">RÃ©sultat</th>
                    </tr>
                    </thead>
                    <tbody id="last-games-list">
                    {% for game in lastGames %}
                        {% set grid = game.grid ?? [] %}
                        <tr>
                            <td>
                                <img src="{{ game.avatarUrl }}"
                                     alt="Avatar"
                                     class="rounded"
                                     style="width:40px;height:40px;">
                            </td>
                            <td class="small">
                                {{ game.username }}
                            </td>
                            <td>
                                <div class="slot-mini-grid d-inline-grid"
                                     style="display:inline-grid;grid-template-columns:repeat(3,20px);gap:2px;">
                                    {% for r in 0..2 %}
                                        {% set row = grid[r] ?? [] %}
                                        {% for c in 0..2 %}
                                            {% set sym = row[c] ?? 'slot8' %}
                                            {% if sym starts with 'slot' %}
                                                {% set index = sym|slice(4) %}
                                            {% else %}
                                                {% set index = '8' %}
                                            {% endif %}
                                            <img src="{{ asset('img/slots/slot' ~ index ~ '.png') }}"
                                                 alt=""
                                                 style="width:20px;height:20px;">
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="small">
                                {% if game.debut_le is defined and game.debut_le %}
                                    {{ game.debut_le|date('d/m/Y H:i') }}
                                {% endif %}
                            </td>
                            <td class="small text-start">
                                <span class="balance">{{ game.mise }}</span>
                            </td>
                            <td class="small text-end">
                                {% if game.resultatNet >= 0 %}
                                    <span class="text-success balance">+{{ game.resultatNet }}</span>
                                {% else %}
                                    <span class="text-danger balance">{{ game.resultatNet }}</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="info-card card text-light mb-3">
        <div class="card-header border-secondary"><span class="typo-title">Table des gains & rarete</span></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-striped align-middle mb-2">
                    <thead>
                    <tr>
                        <th style="width:56px;">Symbole</th>
                        <th>Item</th>
                        <th style="width:160px;">Multiplicateur (Ã—)</th>
                        <th style="width:160px;">Probabilite (~%)</th>
                        <th style="width:220px;">Rarete</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot1.png') }}" width="36" height="36" alt="Emeraude"></td>
                        <td>Emeraude</td>
                        <td>Ã—20</td>
                        <td>{{ percents['slot1']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-danger">TrÃ¨s rare</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot2.png') }}" width="36" height="36" alt="Diamant"></td>
                        <td>Diamant</td>
                        <td>Ã—12</td>
                        <td>{{ percents['slot2']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-warning">Rare</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot3.png') }}" width="36" height="36" alt="Redstone"></td>
                        <td>Redstone</td>
                        <td>Ã—9</td>
                        <td>{{ percents['slot3']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-warning">Peu frequent</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot4.png') }}" width="36" height="36" alt="Or"></td>
                        <td>Or</td>
                        <td>Ã—6</td>
                        <td>{{ percents['slot4']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-info">Intermediaire</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot5.png') }}" width="36" height="36" alt="Lapis"></td>
                        <td>Lapis</td>
                        <td>Ã—5</td>
                        <td>{{ percents['slot5']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-info">Intermediaire</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot6.png') }}" width="36" height="36" alt="Fer"></td>
                        <td>Fer</td>
                        <td>Ã—4</td>
                        <td>{{ percents['slot6']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-secondary">Commun</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot7.png') }}" width="36" height="36" alt="Charbon"></td>
                        <td>Charbon</td>
                        <td>Ã—3</td>
                        <td>{{ percents['slot7']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-secondary">Commun</span></td>
                    </tr>
                    <tr>
                        <td><img src="{{ asset('img/slots/slot8.png') }}" width="36" height="36" alt="BÃ¢ton"></td>
                        <td>BÃ¢ton</td>
                        <td>Ã—1</td>
                        <td>{{ percents['slot8']|number_format(2, ',', ' ') }}%</td>
                        <td><span class="badge text-bg-success">TrÃ¨s commun</span></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <ul class="mb-0 small text-white-50">
                <li>Ponderations cÃ´te serveur : Emeraude (plus rare) â†’ BÃ¢ton (plus commun). Les pourcentages sont approximatifs (tirage pondere).</li>
                <li>Lignes payantes : 3 horizontales, 3 verticales, 2 diagonales (3 identiques = gain).</li>
                <li>Le resultat sâ€™affiche quand lâ€™animation est finie (main propre).</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block game_scripts %}
    <script type="module">
        (function () {
            let wired = false;
            let auto = { active:false, total:0, remaining:0, stop:false };

            const CELL_H = 100;
            const FILL_TOP = 6;
            const FILL_BOTTOM = 6;
            const PRE_TAPE = 18;
            const SPIN_MS = 900;
            const DECEL_COL = [0.86, 0.98, 1.10];
            const STOP_DELAY = [0, 120, 240];
            const BOUNCE_OFFSET = 10;
            const BOUNCE_DOWN_MS = 90;
            const BOUNCE_UP_MS = 140;

            const IMG = [
                "{{ asset('img/slots/slot1.png') }}",
                "{{ asset('img/slots/slot2.png') }}",
                "{{ asset('img/slots/slot3.png') }}",
                "{{ asset('img/slots/slot4.png') }}",
                "{{ asset('img/slots/slot5.png') }}",
                "{{ asset('img/slots/slot6.png') }}",
                "{{ asset('img/slots/slot7.png') }}",
                "{{ asset('img/slots/slot8.png') }}"
            ];

            function init() {
                if (wired) return;

                const playBtn    = document.getElementById('playBtn');
                const betInput   = document.getElementById('betInput');
                const resultEl   = document.getElementById('result');
                const balanceEl  = document.getElementById('balanceDisplay');
                const winLinesEl = document.getElementById('winLines');

                const strips = Array.from(document.querySelectorAll('.reel-strip'));
                const autoCount  = document.getElementById('autoCount');
                const autoStart  = document.getElementById('autoStartBtn');
                const autoStop   = document.getElementById('autoStopBtn');
                const autoStatus = document.getElementById('autoStatus');

                if (!playBtn || !betInput || strips.length !== 3 || !resultEl || !balanceEl || !winLinesEl || !autoCount || !autoStart || !autoStop || !autoStatus) return;
                wired = true;

                const startUrl   = "{{ path('app_game_slots_start') }}";
                const resolveUrl = "{{ path('app_game_slots_resolve') }}";
                const csrf       = "{{ csrf_token('slots_play') }}";

                const sleep = (ms) => new Promise(r => setTimeout(r, ms));
                const setManualDisabled = (d)=>{ playBtn.disabled = !!d; playBtn.classList.toggle('disabled', !!d); };
                const setAutoUI = (active) => {
                    auto.active = active;
                    autoStop.disabled = !active;
                    autoStart.disabled = !!active;
                    betInput.disabled = !!active;
                    setManualDisabled(active);
                };

                function refreshHeaderBalanceLive() {
                    const containers = document.querySelectorAll('[id="header-balance-live"]');
                    if (!containers.length) return;
                    containers.forEach((container) => {
                        const btn = container.querySelector('[data-live-action-param="refresh"]');
                        if (!btn) return;
                        btn.click();
                    });
                }

                function rndArr(n){ const out = new Array(n); for (let i=0;i<n;i++) out[i] = IMG[(Math.random()*IMG.length)|0]; return out; }
                function mapSym(sym){
                    if (typeof sym === 'string' && sym.startsWith('slot')) {
                        const idx = parseInt(sym.slice(4),10);
                        if (idx>=1 && idx<=IMG.length) return IMG[idx-1];
                    }
                    return IMG[7];
                }
                function buildLoopStrip(images){ const html = images.map(src=>`<div class="symbol"><img src="${src}" alt=""></div>`).join(''); return html+html; }

                function clearHighlights(){
                    document.querySelectorAll('.symbol.is-win, .symbol.is-muted').forEach(el=>{
                        el.classList.remove('is-win','is-muted');
                    });
                }

                function startSpin(stripEl, speedMs=SPIN_MS){
                    clearHighlights();
                    const tape = rndArr(PRE_TAPE);
                    stripEl.innerHTML = buildLoopStrip(tape);
                    stripEl.style.setProperty('--spin-speed', `${speedMs}ms`);
                    stripEl.style.transition='none';
                    stripEl.style.transform='translateY(-50%)';
                    stripEl.style.animation = '';
                    void stripEl.offsetWidth;
                    stripEl.classList.add('spin');
                }

                function stopToFinal(stripEl, final3Imgs, decelSec){
                    stripEl.classList.remove('spin');
                    stripEl.style.animation = 'none';

                    const top = rndArr(FILL_TOP);
                    const bottom = rndArr(FILL_BOTTOM);
                    const finalContent = [...top, ...final3Imgs, ...bottom];
                    stripEl.innerHTML = finalContent.map(src=>`<div class="symbol"><img src="${src}" alt=""></div>`).join('');

                    const targetY = -(FILL_TOP * CELL_H);
                    const startY  = -((FILL_TOP + 2) * CELL_H);

                    stripEl.style.transition = 'none';
                    stripEl.style.transform = `translateY(${startY}px)`;
                    void stripEl.offsetWidth;

                    const whenDecelEnd = new Promise((resolve)=>{
                        const onEnd = (ev)=>{
                            if (ev.propertyName !== 'transform') return;
                            stripEl.removeEventListener('transitionend', onEnd);
                            resolve();
                        };
                        stripEl.addEventListener('transitionend', onEnd);

                        requestAnimationFrame(()=>{
                            stripEl.style.transition = `transform ${decelSec}s cubic-bezier(.2,.9,.1,1)`;
                            requestAnimationFrame(()=>{
                                stripEl.style.transform = `translateY(${targetY}px)`;
                            });
                        });
                    });

                    const triggerBounce = ()=>{
                        stripEl.style.transition = `transform ${BOUNCE_DOWN_MS}ms cubic-bezier(.2,.8,.2,1)`;
                        stripEl.style.transform  = `translateY(${targetY + BOUNCE_OFFSET}px)`;
                        setTimeout(()=>{
                            stripEl.style.transition = `transform ${BOUNCE_UP_MS}ms cubic-bezier(.2,1,.2,1)`;
                            stripEl.style.transform  = `translateY(${targetY}px)`;
                        }, BOUNCE_DOWN_MS);
                    };

                    return { whenDecelEnd, triggerBounce };
                }

                async function apiStart(amount){
                    const res = await fetch(startUrl, {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ amount, _token: csrf })
                    });
                    const data = await res.json().catch(()=>null);
                    if (!res.ok || !data || data.ok === false) {
                        const msg = (data && data.error) ? data.error : `Erreur (${res.status})`;
                        throw new Error(msg);
                    }
                    return data;
                }

                async function apiResolve(spinId){
                    const res = await fetch(resolveUrl, {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ spinId, _token: csrf })
                    });
                    const data = await res.json().catch(()=>null);
                    if (!res.ok || !data || data.ok === false) {
                        const msg = (data && data.error) ? data.error : `Erreur (${res.status})`;
                        throw new Error(msg);
                    }
                    return data;
                }

                function renderWins(el, wins){
                    el.textContent = (wins && wins.length)
                        ? wins.map(l => `${l.name} Ã—${l.multiplier}`).join(' Â· ')
                        : 'â€”';
                }

                function highlightVisibleWins(strips, wins){
                    clearHighlights();
                    if (!wins || !wins.length) return;

                    const WIN_POS = new Set(wins.flatMap(line => line.positions.map(([r,c]) => `${r}:${c}`)));

                    for (let c=0; c<3; c++){
                        const strip = strips[c];
                        for (let r=0; r<3; r++){
                            const child = strip.children[FILL_TOP + r];
                            if (!child) continue;
                            const key = `${r}:${c}`;
                            if (WIN_POS.has(key)) child.classList.add('is-win');
                            else child.classList.add('is-muted');
                        }
                    }
                }

                async function playOnce(amount){
                    resultEl.textContent = 'Lancementâ€¦';
                    winLinesEl.textContent = 'â€”';
                    clearHighlights();

                    let spinId;
                    try { spinId = (await apiStart(amount)).spinId; }
                    catch(e){
                        resultEl.textContent = e.message || 'Erreur';
                        auto.stop = true;
                        return;
                    }

                    strips.forEach((s, i) => startSpin(s, SPIN_MS + i*80));
                    await sleep(320);

                    let data;
                    try { data = await apiResolve(spinId); }
                    catch(e){ resultEl.textContent = e.message || 'Erreur'; return; }

                    const col0 = [data.grid[0][0], data.grid[1][0], data.grid[2][0]].map(mapSym);
                    const col1 = [data.grid[0][1], data.grid[1][1], data.grid[2][1]].map(mapSym);
                    const col2 = [data.grid[0][2], data.grid[1][2], data.grid[2][2]].map(mapSym);

                    const s0 = stopToFinal(strips[0], col0, DECEL_COL[0]);
                    await sleep(120);
                    const s1 = stopToFinal(strips[1], col1, DECEL_COL[1]);
                    await sleep(120);
                    const s2 = stopToFinal(strips[2], col2, DECEL_COL[2]);

                    await Promise.all([s0.whenDecelEnd, s1.whenDecelEnd, s2.whenDecelEnd]);

                    highlightVisibleWins(strips, data.wins || []);

                    renderWins(winLinesEl, data.wins || []);
                    refreshHeaderBalanceLive();

                    const payout = Number(data.payout || 0);
                    const net    = Number.isFinite(Number(data.net)) ? Number(data.net) : (payout - amount);
                    const isWin  = payout > 0;

                    // ðŸ”¹ Mise Ã  jour des stats de session (tous jeux confondus)
                    if (window.SymfsinoSessionHistory && typeof window.SymfsinoSessionHistory.update === 'function') {
                        window.SymfsinoSessionHistory.update(net, amount, payout);
                    }

                    requestAnimationFrame(()=>{
                        resultEl.textContent = isWin ? `Gagne +${payout}` : `Perdu -${amount}`;
                        s0.triggerBounce(); s1.triggerBounce(); s2.triggerBounce();
                    });
                }

                async function onManual(ev){
                    if (ev) ev.preventDefault();
                    if (auto.active) return;
                    const amount = parseInt(betInput.value,10) || 0;
                    setManualDisabled(true);
                    try { await playOnce(amount); }
                    catch(e){ resultEl.textContent = e.message || 'Erreur'; }
                    finally { setManualDisabled(false); }
                }

                async function runAuto(){
                    const amount = parseInt(betInput.value,10) || 0;
                    auto.stop = false; setAutoUI(true);
                    while (auto.remaining > 0 && !auto.stop) {
                        const idx = auto.total - auto.remaining + 1;
                        autoStatus.textContent = `Auto : lancer ${idx}/${auto.total}`;
                        try { await playOnce(amount); }
                        catch(e){ resultEl.textContent = e.message || 'Erreur'; break; }
                        auto.remaining--;
                        if (auto.remaining > 0 && !auto.stop) await sleep(250);
                    }
                    autoStatus.textContent = 'Auto : termine';
                    setAutoUI(false);
                }

                function onAutoStart(ev){
                    if (ev) ev.preventDefault();
                    if (auto.active) return;
                    const n = Math.max(1, parseInt(autoCount.value,10) || 0);
                    auto.total = n; auto.remaining = n;
                    autoStatus.textContent = `Auto : prÃªt (${n})`;
                    runAuto();
                }
                function onAutoStop(ev){
                    if (ev) ev.preventDefault();
                    if (!auto.active) return;
                    auto.stop = true;
                    autoStatus.textContent = 'Auto : arrÃªt demandeâ€¦';
                }

                playBtn.addEventListener('click', onManual);
                autoStart.addEventListener('click', onAutoStart);
                autoStop.addEventListener('click', onAutoStop);
            }

            document.addEventListener('DOMContentLoaded', init);
            document.addEventListener('turbo:load', init);
        })();
    </script>
{% endblock %}
